#!/bin/sh
#
# Copyright (C) 2010-2012 Ian Moore <imooreyahoo@gmail.com>
# Copyright (C) 2013-2018 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_MYSQL_PLUGIN_MARIADB_CONFIG_DIR=${OMV_MYSQL_PLUGIN_MYSQL_CONFIG_DIR:-"/etc/mysql/mariadb.conf.d"}
OMV_MYSQL_PLUGIN_CONFIG=${OMV_MYSQL_PLUGIN_CONFIG:-"99-openmediavault-mysql.cnf"}
OMV_MYSQL_PLUGIN_XPATH="/config/services/mysql"

conf="${OMV_MYSQL_PLUGIN_MARIADB_CONFIG_DIR}/${OMV_MYSQL_PLUGIN_CONFIG}"

# remove old config files if they exist
if [ -f "${conf}" ]; then
    rm "${conf}"
fi

# Generate configuration only if the service is enabled.
if [ "$(omv_config_get "${OMV_MYSQL_PLUGIN_XPATH}/enable")" != "1" ]; then
    exit 0
fi

# Generate the MySQL configuration.
xmlstarlet sel -t -m "${OMV_MYSQL_PLUGIN_XPATH}" \
    -o "# This configuration file automatically generated by openmediavault-mysql." -n \
    -o "# Changes to this file will be automatically overwritten." -n -n \
    -o "[mysqld]" -n \
    -i "enable_networking != 1" -o "skip-networking" -n -b \
    -i "port != ''" -v "concat('port = ', port)" -n -b \
    -i "bind_address != ''" -v "concat('bind-address = ', bind_address)" -n -b \
    -i "disable_aio != 0" -o "innodb_use_native_aio=0" -n -b \
    -i "string-length(extra_options) > 0" -v "extra_options" -n -b \
    ${OMV_CONFIG_FILE} | xmlstarlet unesc > "${conf}"

# Set permissions on the configuration file.
chmod 644 "${conf}"

exit 0
